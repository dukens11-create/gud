name: Build iOS

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      upload_to_testflight:
        description: 'Upload to TestFlight'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

  # Automatic trigger on version tags
  push:
    tags:
      - 'v*'  # Matches v1.0.0, v2.1.0, etc.

  # Trigger on release creation
  release:
    types: [created, published]

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Validate iOS Firebase Configuration
        run: |
          chmod +x scripts/validate_firebase_ios.sh
          if ! ./scripts/validate_firebase_ios.sh; then
            echo "âŒ iOS Firebase configuration validation failed!"
            echo "The GoogleService-Info.plist file contains placeholder values."
            echo "Please see docs/FIREBASE_IOS_SETUP.md for setup instructions."
            exit 1
          fi

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      - name: Install Fastlane
        run: |
          cd ios
          bundle install

      - name: Create temporary keychain
        run: |
          # Create a temporary keychain for CI
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD || 'temppass' }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD || 'temppass' }}" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

      - name: Decode and import certificates
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          # Decode the certificate
          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > certificate.p12

          # Import certificate to keychain
          security import certificate.p12 \
            -k build.keychain \
            -P "$IOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          # Set key partition list
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.KEYCHAIN_PASSWORD || 'temppass' }}" build.keychain

          # Clean up certificate file
          rm -f certificate.p12

      - name: Decode and install provisioning profile
        env:
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create provisioning profiles directory
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

          # Decode and save provisioning profile
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > profile.mobileprovision

          # Get UUID from provisioning profile
          PROFILE_UUID=$(grep -a -A 1 'UUID' profile.mobileprovision | grep string | sed -e 's/<string>//' -e 's/<\/string>//' -e 's/^[[:space:]]*//')

          # Copy to provisioning profiles directory
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$PROFILE_UUID.mobileprovision

          # Clean up
          rm -f profile.mobileprovision

      - name: Set up App Store Connect API Key
        env:
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          # Create App Store Connect API Key directory
          mkdir -p ~/.appstoreconnect/private_keys

          # Decode and save API key
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

          # Set environment variable for Fastlane
          echo "APP_STORE_CONNECT_API_KEY_PATH=~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8" >> $GITHUB_ENV

      - name: Update version in Info.plist
        run: |
          # Extract version from pubspec.yaml
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | cut -d'+' -f2)

          echo "Building version $VERSION ($BUILD_NUMBER)"

          # Update Info.plist (Flutter handles this automatically, but we can verify)
          /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" ios/Runner/Info.plist || true

      - name: Build IPA
        run: |
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --no-codesign

      - name: Upload IPA to App Store Connect (via Fastlane)
        if: github.event_name == 'release' || github.event.inputs.upload_to_testflight == 'true'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          ITC_TEAM_ID: ${{ secrets.ITC_TEAM_ID }}
        run: |
          cd ios
          bundle exec fastlane upload_testflight

      - name: Upload IPA as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
          retention-days: 30

      - name: Clean up keychain and certificates
        if: always()
        run: |
          # Delete temporary keychain
          security delete-keychain build.keychain || true

          # Clean up any leftover files
          rm -f certificate.p12 profile.mobileprovision || true
          rm -rf ~/.appstoreconnect/private_keys || true

      - name: Build summary
        if: success()
        run: |
          echo "âœ… iOS IPA built successfully!"
          echo "ðŸ“¦ IPA location: build/ios/ipa/"
          ls -lh build/ios/ipa/ || true
