name: Build Android App Bundle (AAB)

on:
  # Manual workflow dispatch
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: false
        default: 'release'
        type: choice
        options:
          - release
          - debug
      run_tests:
        description: 'Run tests before building'
        required: false
        default: true
        type: boolean
  
  # Automatic trigger on version tags
  push:
    tags:
      - 'v*'
  
  # Automatic trigger on release creation
  release:
    types: [created, published]
  
  # Optional: scheduled builds (weekly on Mondays at 2 AM UTC)
  schedule:
    - cron: '0 2 * * 1'

jobs:
  build-aab:
    name: Build AAB with Signing
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'
      
      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Flutter doctor
        run: flutter doctor -v
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Run Flutter analyze
        run: flutter analyze --fatal-infos
        continue-on-error: true
      
      - name: Run Flutter tests
        if: ${{ github.event.inputs.run_tests != 'false' }}
        run: flutter test
        continue-on-error: true
      
      - name: Extract version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: *//')
          VERSION_NAME=$(echo $VERSION | cut -d'+' -f1)
          VERSION_CODE=$(echo $VERSION | cut -d'+' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Building version: $VERSION_NAME ($VERSION_CODE)"
      
      - name: Decode keystore from secrets
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "ðŸ” Decoding keystore..."
          echo "$KEYSTORE_BASE64" | base64 --decode > android/gud_keystore.jks
          ls -lh android/gud_keystore.jks
          echo "âœ… Keystore decoded successfully"
      
      - name: Create key.properties
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "ðŸ”‘ Creating key.properties..."
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=gud_keystore.jks
          EOF
          echo "âœ… key.properties created"
      
      - name: Build Android App Bundle (Release)
        run: |
          echo "ðŸ—ï¸ Building AAB..."
          flutter build appbundle --release \
            --build-number=${{ github.run_number }} \
            --verbose
          echo "âœ… AAB build completed"
      
      - name: Verify AAB file
        run: |
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            echo "âœ… AAB file exists"
            ls -lh "$AAB_PATH"
            SIZE=$(du -h "$AAB_PATH" | cut -f1)
            echo "ðŸ“¦ AAB size: $SIZE"
            echo "aab_size=$SIZE" >> $GITHUB_ENV
          else
            echo "âŒ AAB file not found"
            exit 1
          fi
      
      - name: Verify mapping file
        run: |
          MAPPING_PATH="build/app/outputs/mapping/release/mapping.txt"
          if [ -f "$MAPPING_PATH" ]; then
            echo "âœ… Mapping file exists"
            ls -lh "$MAPPING_PATH"
          else
            echo "âš ï¸ Mapping file not found (may not be generated for all builds)"
          fi
      
      - name: Clean up sensitive files
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up sensitive files..."
          rm -f android/gud_keystore.jks
          rm -f android/key.properties
          echo "âœ… Cleanup completed"
      
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: gud-express-aab-${{ github.run_number }}-v${{ steps.version.outputs.version_name }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
          if-no-files-found: error
      
      - name: Upload mapping file artifact
        uses: actions/upload-artifact@v4
        if: hashFiles('build/app/outputs/mapping/release/mapping.txt') != ''
        with:
          name: gud-express-mapping-${{ github.run_number }}-v${{ steps.version.outputs.version_name }}
          path: build/app/outputs/mapping/release/mapping.txt
          retention-days: 90
          if-no-files-found: warn
      
      - name: Create release asset
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/mapping/release/mapping.txt
          tag_name: ${{ github.ref_name }}
          name: GUD Express v${{ steps.version.outputs.version_name }}
          body: |
            ## ðŸ“¦ GUD Express v${{ steps.version.outputs.version_name }}
            
            ### Android App Bundle
            - **Version**: ${{ steps.version.outputs.version_name }}
            - **Build Number**: ${{ github.run_number }}
            - **Size**: ${{ env.aab_size }}
            
            ### ðŸ“¥ Downloads
            - `app-release.aab` - Android App Bundle for Google Play Store
            - `mapping.txt` - ProGuard mapping file for crash analysis
            
            ### ðŸš€ Installation
            1. Download the AAB file
            2. Upload to Google Play Console
            3. Create a new release in the Production track
            
            Built with â¤ï¸ by GitHub Actions
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AAB: \`build/app/outputs/bundle/release/app-release.aab\`" >> $GITHUB_STEP_SUMMARY
          if [ -f "build/app/outputs/mapping/release/mapping.txt" ]; then
            echo "- âœ… Mapping: \`build/app/outputs/mapping/release/mapping.txt\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ Mapping file not generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Navigate to the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) to download the built artifacts." >> $GITHUB_STEP_SUMMARY
