name: Build Android App Bundle (AAB)

# Workflow triggers
on:
  # Manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      flutter_version:
        description: 'Flutter version to use'
        required: false
        default: 'stable'
        type: choice
        options:
          - stable
          - 3.24.0

  # Trigger on version tags (e.g., v2.1.0, v2.1.1)
  push:
    tags:
      - 'v*'

  # Trigger on releases
  release:
    types: [published, created]

# Set permissions for the workflow
permissions:
  contents: read
  actions: read

jobs:
  build-aab:
    name: Build Signed AAB
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Security: Restrict workflow to main repository only
    if: github.repository == 'dukens11-create/gud'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ github.event.inputs.flutter_version || 'stable' }}
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze
        continue-on-error: true

      # Security: Decode keystore from base64-encoded secret
      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "âŒ Error: KEYSTORE_BASE64 secret is not set"
            echo "Please follow the guide in GITHUB_ACTIONS_AAB_GUIDE.md to set up secrets"
            exit 1
          fi
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
          echo "âœ… Keystore decoded successfully"

      # Security: Create key.properties from secrets
      - name: Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          if [ -z "$KEYSTORE_PASSWORD" ] || [ -z "$KEY_PASSWORD" ] || [ -z "$KEY_ALIAS" ]; then
            echo "âŒ Error: One or more keystore secrets are missing"
            echo "Required secrets: KEYSTORE_PASSWORD, KEY_PASSWORD, KEY_ALIAS"
            echo "Please follow the guide in GITHUB_ACTIONS_AAB_GUIDE.md"
            exit 1
          fi

          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF
          echo "âœ… key.properties created successfully"

      - name: Build release AAB
        run: |
          echo "ðŸš€ Building Android App Bundle (AAB)..."
          flutter build appbundle --release --verbose
          echo "âœ… AAB build completed successfully"

      - name: Verify AAB file
        run: |
          AAB_PATH="build/app/outputs/bundle/release/app-release.aab"
          if [ -f "$AAB_PATH" ]; then
            AAB_SIZE=$(du -h "$AAB_PATH" | cut -f1)
            echo "âœ… AAB file found: $AAB_PATH"
            echo "ðŸ“¦ AAB size: $AAB_SIZE"
            ls -lh "$AAB_PATH"
          else
            echo "âŒ Error: AAB file not found at $AAB_PATH"
            exit 1
          fi

      # Extract version information from pubspec.yaml
      - name: Get version information
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“± App version: $VERSION"

      # Upload AAB as artifact
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: gud-express-aab-${{ steps.version.outputs.version }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 90
          compression-level: 9

      # Security: Clean up sensitive files
      - name: Clean up sensitive files
        if: always()
        run: |
          rm -f android/app/upload-keystore.jks
          rm -f android/key.properties
          echo "âœ… Sensitive files cleaned up"

      # Generate build summary
      - name: Generate build summary
        if: success()
        run: |
          echo "## ðŸŽ‰ AAB Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Download AAB" >> $GITHUB_STEP_SUMMARY
          echo "The signed AAB is available as a workflow artifact." >> $GITHUB_STEP_SUMMARY
          echo "You can download it from the [Actions tab](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the AAB artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to Google Play Console" >> $GITHUB_STEP_SUMMARY
          echo "3. Submit for review" >> $GITHUB_STEP_SUMMARY

      - name: Build failed summary
        if: failure()
        run: |
          echo "## âŒ AAB Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Common Issues:" >> $GITHUB_STEP_SUMMARY
          echo "- Missing or invalid GitHub Secrets (KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_PASSWORD, KEY_ALIAS)" >> $GITHUB_STEP_SUMMARY
          echo "- Invalid keystore file" >> $GITHUB_STEP_SUMMARY
          echo "- Flutter build errors" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See GITHUB_ACTIONS_AAB_GUIDE.md for setup instructions." >> $GITHUB_STEP_SUMMARY
